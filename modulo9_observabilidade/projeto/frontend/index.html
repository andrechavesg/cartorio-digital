<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Cartório Digital - Observabilidade</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
      }
      section {
        margin-bottom: 2rem;
      }
      form {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      textarea,
      input,
      button {
        padding: 0.5rem;
      }
      textarea {
        grid-column: span 2;
        height: 100px;
      }
      pre {
        background: #f5f5f5;
        padding: 1rem;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>Cartório Digital &mdash; Observabilidade</h1>

    <section>
      <h2>Métricas</h2>
      <form id="metric-form">
        <input type="text" id="metric-name" placeholder="Nome" required />
        <input type="number" step="0.01" id="metric-value" placeholder="Valor" required />
        <textarea id="metric-labels" placeholder='Labels JSON (ex: {"service": "api"})'></textarea>
        <button type="submit">Registrar métrica</button>
      </form>
    </section>

    <section>
      <h2>Traces</h2>
      <form id="trace-form">
        <input type="text" id="span-id" placeholder="Span ID" required />
        <input type="text" id="span-name" placeholder="Nome" required />
        <input type="number" step="0.01" id="span-duration" placeholder="Duração (ms)" required />
        <textarea id="span-attributes" placeholder='Atributos JSON'></textarea>
        <button type="submit">Registrar trace</button>
      </form>
    </section>

    <section>
      <h2>Logs</h2>
      <form id="log-form">
        <input type="text" id="log-level" placeholder="Nível" required />
        <input type="text" id="log-message" placeholder="Mensagem" required />
        <textarea id="log-context" placeholder='Contexto JSON'></textarea>
        <button type="submit">Registrar log</button>
      </form>
    </section>

    <section>
      <h2>Snapshot</h2>
      <button id="refresh-snapshot">Atualizar</button>
      <pre id="snapshot"></pre>
    </section>

    <section>
      <h2>Formato Prometheus</h2>
      <button id="refresh-prom">Atualizar métricas</button>
      <pre id="prom"></pre>
    </section>

    <script>
      const API_BASE = "http://localhost:8000";

      function parseJsonOrEmpty(value) {
        if (!value) return {};
        try {
          return JSON.parse(value);
        } catch (err) {
          alert("JSON inválido: " + err.message);
          throw err;
        }
      }

      async function refreshSnapshot() {
        const response = await fetch(`${API_BASE}/snapshot`);
        const data = await response.json();
        document.getElementById("snapshot").textContent = JSON.stringify(
          data,
          null,
          2
        );
      }

      async function refreshProm() {
        const response = await fetch(`${API_BASE}/metrics/prometheus`);
        const text = await response.text();
        document.getElementById("prom").textContent = text;
      }

      document
        .getElementById("metric-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          await fetch(`${API_BASE}/metrics`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: document.getElementById("metric-name").value,
              value: Number(document.getElementById("metric-value").value),
              labels: parseJsonOrEmpty(document.getElementById("metric-labels").value),
            }),
          });
          refreshSnapshot();
          refreshProm();
        });

      document
        .getElementById("trace-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          await fetch(`${API_BASE}/traces`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              span_id: document.getElementById("span-id").value,
              name: document.getElementById("span-name").value,
              duration_ms: Number(document.getElementById("span-duration").value),
              attributes: parseJsonOrEmpty(document.getElementById("span-attributes").value),
            }),
          });
          refreshSnapshot();
        });

      document
        .getElementById("log-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          await fetch(`${API_BASE}/logs`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              level: document.getElementById("log-level").value,
              message: document.getElementById("log-message").value,
              context: parseJsonOrEmpty(document.getElementById("log-context").value),
            }),
          });
          refreshSnapshot();
        });

      document.getElementById("refresh-snapshot").addEventListener("click", () => {
        refreshSnapshot();
      });

      document.getElementById("refresh-prom").addEventListener("click", () => {
        refreshProm();
      });

      refreshSnapshot();
      refreshProm();
    </script>
  </body>
</html>
